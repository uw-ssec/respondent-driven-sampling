# API Documentation 

## Introduction 

This documentation describes the API that serves the RDS web app - a full-stack web application designed to streamline data collection and participant tracking using Respondent-Driven Sampling (RDS) methods. This system enables survey administrators to securely manage participant entries, authenticate users, and monitor referral-based outreach efforts, all while prioritizing accessibility, security, and ease of use. The API for the RDS web app contains endpoints that performs integral functionaltiy 

There are two primary routes in the RDS Web API. The `auth` route has endpoints that facilitate all user tasks. Some of these tasks include signing users in, fetching user profiles or editing user permissions. The `surveys` route has endpoints that facilitate survey tasks. These tasks incldue things such as fetching surveys, submitting surveys or deleting surveys. 

TODO: Maybe add stuff about security here? 

This documentation will help you navigate the RDS App API.

### Permissions

TODO: Explain permissions and the middleware errors here

## Survey Endpoints

### `POST 'api/surveys/save'`

**Description:** Saves a survey to a database. This saves an instance of the database exactly as given in the body of the request. The "responses" object does not have to contain a full survey, and this endpoint can be used for either submitting "completed" surveys are "in progress" surveys. If no object id is provided
obe ht ni

**Example Request:** 

*URL:* /api/surveys/save

*Headers:* 
```typescript
{
  "Authorization": `Bearer ${token}`
}
```

*Body:*
```typescript
{
  "responses": {
    "location": "Bellevue Library", 
    ""interpreter"": "No",
    "consent_give": "Yes"
  },
  "referredByCode:" : "7Z34G96G", 
  "coords" : {0, 0}, 
  "objectId" "68c0c83d2217fd19876a549d"
  "inProgress": true
}
```

**Example Response:**
```json
{
  "message": "Survey saved successfully!",
  "objectId": "68c0c83d2217fd19876a549d",
  "referralCodes": ["L4DNMDWK", "GVPZDXSQ", "O1E9EB4G"]
}
```

**Error Handling:**

- `400` "Missing required fields"
  - This means that there were missing parameters. The required parameter for this endpoint is `responses`.


- `500` "Server error: Could not save survey"
  - This error occurs when there is an error in the server. 

### `GET 'api/surveys/validate-ref/:code'`

**Description:** This endpoint ensures that a given referral code is valid. A code is valid if it was generated by our server and is currently linked with its parent survey, and it has not been used in any saved surveys within the database. 

**Example Request:** /api/surveys/validate-ref/7Z34G96G

**Headers:** 

```typescript
{
  "Authorization": `Bearer ${token}`
}
```

**Example Response:**
```json
{
  "message" : "Valid referral code.", 
  "surveyId": "68c0c83d2217fd19876a549d"
}
```

**Error Handling:**

- `400` "Referral code not found."
  - This means that the given referral code was not generated by the server and is not currently associated with any existing surveys in the database. 

- `400` "This survey is in progress. Please continue."
  - This means that the given referral code was used in an in progress survey. This means there is an exisitng survey document in the database with the given referral code, and this survey has an `inProgress` field set to `true`.

- `400` "This referral code has already been used."
  - This means that the given referral code was used in a previously completed survey. This means there is an exisitng survey document in the database with the given referral code, and this survey has an `inProgress` field set to `false`.

- `500` "Server error. Unable to validate referral code"
  - This error occurs when there is an error in the server. 

### `GET 'api/surveys/all'`

**Description:** This endpoint returns all surveys that the client has permission to access. 

**Example Request:** /api/surveys/all

**Headers:** 

```typescript
{
  "Authorization": `Bearer ${token}`
}
```

**Example Response:**
```json
{
  {
    "_id": "68c0c83d2217fd19876a549d",
    "employeeId": "EMP1145",
    "employeeName": "Kristen",
    "responses": {
      "location": "Location X",
      "interpreter":"No",
    },
    "lastUpdated": "2025-09-10T00:37:43.553Z",
    "inProgress": false,
    "referredByCode": "7Z34G96G",
    "coords": { "latitude" :0, "longitude": 0 },
    "createdAt": "2025-09-10T00:37:17.216Z",
    "referralCodes": [["L4DNMDWK", "GVPZDXSQ", "O1E9EB4G"]],
    "__v": 1
  }, 
  {
    "_id": "34yhc83217gh166546a349d",
    "employeeId": "EMP1219",
    "employeeName": "John",
    "responses": {
      "location": "Location Y",
      "interpreter":"No",
    },
    "lastUpdated": "2025-10-10T00:37:43.553Z",
    "inProgress": false,
    "referredByCode": "7Z34G",
    "coords": { "latitude" :0, "longitude": 0 },
    "createdAt": "2025-09-10T00:37:17.216Z",
    "referralCodes": [["L4DNMDWK", "GVPZDXSQ", "O1E9EB4G"]],
    "__v": 1
  }
}
```

**Error Handling:**
- `400` "Access denied. Invalid user permissions"
  - This error indicates that the client calling this endpoint does not have the required permissions to fetch all surveys. 

- `500` "Server error: Unable to fetch surveys"
  - This error occurs when there is an error in the server. 

### `GET 'api/surveys/:id'`

**Description:** This endpoint will fetch a specific survey given its object id.

**Example Request:** /api/surveys/34yhc83217gh166546a349d

*Headers:*

```typescript
{
  "Authorization": `Bearer ${token}`
}
```

**Example Response:**
```json
{
  "_id": "34yhc83217gh166546a349d",
  "employeeId": "EMP1219",
  "employeeName": "John",
  "responses": {
    "location": "Location Y",
    "interpreter":"No",
  },
  "lastUpdated": "2025-10-10T00:37:43.553Z",
  "inProgress": false,
  "referredByCode": "7Z34G",
  "coords": { "latitude" :0, "longitude": 0 },
  "createdAt": "2025-09-10T00:37:17.216Z",
  "referralCodes": [["L4DNMDWK", "GVPZDXSQ", "O1E9EB4G"]],
  "__v": 1
}
```

**Error Handling:**
- `400` "Access denied. Invalid user permissions"
  - This error indicates that the client calling this endpoint does not have the required permissions to fetch this survey. 

- `500` "Server error: Unable to fetch survey"
  - This error occurs when there is an error in the server. 

### `DELETE 'api/surveys/:id'`

**Description:** This endpoint will delete all responses from a survey other than core demographics. 

**Example Request:** 

*URL:* api/surveys/68c0c83d2217fd19876a549d

*Headers:* 
```typescript
{
  "Authorization": `Bearer ${token}`
}
```

**Example Response:**
```json
{
  "message": "Survey responses successfully deleted!"
}
```

**Error Handling:**
- `404` "Survey not found"
  - This error indicates that the survey the client is attempting to delete does not exist in the database

- `403` "Access denied. Invalid user permissions"
  - This error indicates that the client calling this endpoint does not have the required permissions to delete the survey responses.  

- `500` "Server error: Unable to  delete survey"
  - This error occurs when there is an error in the server. 

## Auth Endpoints

### `POST 'api/auth/send-otp-signup'`

**Description:** Sends otp to given phone number for first step in process to create a new user on signup. Requires `phone` and `email` field in body. Does not require auth token.

**Required Permissions:** None

**Example Request:** 

*URL:* 'api/auth/send-otp-signup'

*Headers:* None

*Body:*

```typescript
{
  "phone": `16062134521`
  "email": `rdsapp@uw.edu`
}
```

**Example Response:**
```json
{
  "message": "OTP sent!"
}
```

**Error Handling:**

- `400` "Bad Request. Missing required fields"
  - This means that there were missing parameters. The required parameters for this endpoint are `phone` and `email`.

- `400` "User already exists â€“ please log in."
  - This means that the user already exist in the database. The user should instead log in.

- `500` "Failed to send OTP"
  - This error occurs when there is an error in the server.

### `POST 'api/auth/send-otp-login'`

**Description:** Sends otp to given phone number to for first step in process to log in. Requires `phone` and `email` field in body. Does not require auth token.

**Example Request:** 

*URL:* 'api/auth/send-otp-login'

*Headers:* None

*Body:*

```typescript
{
  "phone": `16062134521`
  "email": `rdsapp@uw.edu`
}
```

**Example Response:**
```json
{
  
}
```

**Error Handling:**

- `400` "Bad Request. Missing required fields"
  - This means that there were missing parameters. The required parameters for this endpoint are `phone` and `email`.

- `404` "User not found."
  - This means that the user was not found. Suggesting bad inputs or the user needs to sign up.

- `500` "Failed to send OTP"
  - This error occurs when there is an error in the server.

### `POST 'api/auth/verify-otp-signup'`

**Description:** Describe endpoint \

**Example Request:** 

*URL:*

*Headers:* 
```typescript
{
  "Authorization": `Bearer ${token}`
}
```

*Body:*

```typescript
{
  "Authorization": `Bearer ${token}`
}
```

**Example Response:**
```json
{
  
}
```

**Error Handling:**
Write error handling

### `POST 'api/auth/verify-otp-login'`

**Description:** Describe endpoint \

**Example Request:** 

*URL:*

*Headers:* 
```typescript
{
  "Authorization": `Bearer ${token}`
}
```

*Body:*

```typescript
{
  "Authorization": `Bearer ${token}`
}
```

**Example Response:**
```json
{
  
}
```

**Error Handling:**
Write error handling

### `GET 'api/auth/users'`

**Description:** Describe endpoint \

**Example Request:** 

*URL:*

*Headers:* 
```typescript
{
  "Authorization": `Bearer ${token}`
}
```

*Body:*

```typescript
{
  "Authorization": `Bearer ${token}`
}
```

**Example Response:**
```json
{
  
}
```

**Error Handling:**
Write error handling

### `PUT 'api/auth/users/:id/approve'`

**Description:** Describe endpoint \

**Example Request:** 

*URL:*

*Headers:* 
```typescript
{
  "Authorization": `Bearer ${token}`
}
```

*Body:*

```typescript
{
  "Authorization": `Bearer ${token}`
}
```

**Example Response:**
```json
{
  
}
```

**Error Handling:**
Write error handling

### `POST 'api/auth/preapprove'`

**Description:** Describe endpoint \

**Example Request:** 

*URL:*

*Headers:* 
```typescript
{
  "Authorization": `Bearer ${token}`
}
```

*Body:*

```typescript
{
  "Authorization": `Bearer ${token}`
}
```

**Example Response:**
```json
{
  
}
```

**Error Handling:**
Write error handling

### `GET 'api/auth/users/:"employeeId"'`

**Description:** Describe endpoint \

**Example Request:** 

*URL:*

*Headers:* 
```typescript
{
  "Authorization": `Bearer ${token}`
}
```

*Body:*

```typescript
{
  "Authorization": `Bearer ${token}`
}
```

**Example Response:**
```json
{
  
}
```

**Error Handling:**
Write error handling

### `PUT 'api/auth/users/:"employeeId"'`

**Description:** Describe endpoint \

**Example Request:** 

*URL:*

*Headers:* 
```typescript
{
  "Authorization": `Bearer ${token}`
}
```

*Body:*

```typescript
{
  "Authorization": `Bearer ${token}`
}
```

**Example Response:**
```json
{
  
}
```

**Error Handling:**
Write error handling

### `GET 'api/auth/users/by-id/:id'`

**Description:** Describe endpoint \

**Example Request:** 

*URL:*

*Headers:* 
```typescript
{
  "Authorization": `Bearer ${token}`
}
```

*Body:*

```typescript
{
  "Authorization": `Bearer ${token}`
}
```

**Example Response:**
```json
{
  
}
```

**Error Handling:**
Write error handling

### `PUT 'api/auth/users/by-id/:id'`

**Description:** Describe endpoint \

**Example Request:** 

*URL:*

*Headers:* 
```typescript
{
  "Authorization": `Bearer ${token}`
}
```

*Body:*

```typescript
{
  "Authorization": `Bearer ${token}`
}
```

**Example Response:**
```json
{
  
}
```

**Error Handling:**
Write error handling

### `GET 'api/auth/:id'`

**Description:** Describe endpoint 

**Example Request:** 

*URL:*

*Headers:* 
```typescript
{
  "Authorization": `Bearer ${token}`
}
```

*Body:*

```typescript
{
  "Authorization": `Bearer ${token}`
}
```

**Example Response:**
```json
{
  
}
```

**Error Handling:**
Write error handling



## For later

**Required Permissions:**
  - Type: `view_survey`  
  - Limiter: `All` or `Self`

  **Required Permissions:**
  - Type: `edit_profile` and `change_perms` (if changing perms) 
  - Limiter: `All` to edit